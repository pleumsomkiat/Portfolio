<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Travel Train: Dual Control | Kiki Oracle</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #87CEEB;
            font-family: sans-serif;
        }

        /* Information Panel */
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            pointer-events: none;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Control Panel */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(255, 255, 255, 0.85);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            align-items: center;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: #fff;
            color: #333;
            border: 1px solid #aaa;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        button:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
        }

        button.active {
            background: #D4AF37;
            color: #fff;
            border-color: #b5952f;
        }

        button.active-blue {
            background: #4682B4;
            color: #fff;
            border-color: #315f85;
        }

        .label {
            font-size: 12px;
            color: #555;
            margin-top: 5px;
        }

        #footer {
            position: absolute;
            bottom: 10px;
            right: 20px;
            color: #fff;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        input[type=range] {
            width: 200px;
        }
    </style>
</head>

<body>

    <div id="info">
        <div style="font-weight: bold; font-size: 1.2rem;">TRAIN VIEW: CNX &rsaquo; PHS</div>
        <div id="trainSelectName" style="color: #D4AF37; font-weight: bold; margin-top: 5px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°: ‡∏Ç‡∏ö‡∏ß‡∏ô Kiki
            Gold</div>
        <div id="location" style="margin-top: 5px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡∏ñ...</div>
        <div class="label" id="timestamp">--:--:--</div>
    </div>

    <div id="controls">
        <div class="row">
            <span>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡∏ö‡∏ß‡∏ô:</span>
            <button id="btnTrain1" class="active" onclick="selectTrain(1)">Kiki Gold (‡∏Ç‡∏ö‡∏ß‡∏ô‡∏ó‡∏≠‡∏á)</button>
            <button id="btnTrain2" onclick="selectTrain(2)">Ocean Express (‡∏Ç‡∏ö‡∏ß‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)</button>
        </div>

        <div class="row">
            <span>‡∏°‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á:</span>
            <button id="viewBtn" onclick="cycleView()">‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ñ‡πÑ‡∏ü (Front)</button>
        </div>

        <div class="slider-container">
            <span id="speedLabel">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏ö‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</span>
            <div class="row">
                <button onclick="changeSpeed(-0.0004)">‚óÄ‚óÄ ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡πá‡∏ß</button>
                <button onclick="changeSpeed(-0.0001)">‚óÄ ‡∏ñ‡∏≠‡∏¢‡∏ä‡πâ‡∏≤</button>
                <button onclick="changeSpeed(0)">‡∏´‡∏¢‡∏∏‡∏î (Stop)</button>
                <button onclick="changeSpeed(0.0001)">‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πâ‡∏≤ ‚ñ∂</button>
                <button onclick="changeSpeed(0.0004)">‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‚ñ∂‚ñ∂</button>
            </div>
        </div>
    </div>

    <div id="footer">Created by ‡∏Å‡∏µ‡∏Å‡∏µ‡πâ (Kiki) Oracle</div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // CSV Data (Waypoints)
        const rawData = [
            [18.464717, 99.05675, "Mueang Lamphun", "08:04:17"],
            [18.456181, 99.057669, "Mueang Lamphun", "08:09:47"],
            [18.456107, 99.087873, "Mae Tha", "08:14:32"],
            [18.461019, 99.137354, "Mae Tha", "08:18:36"],
            [18.392756, 99.265662, "Hang Chat", "09:01:45"],
            [18.364852, 99.287066, "Hang Chat", "09:07:09"],
            [18.37956, 99.305078, "Hang Chat", "09:11:23"],
            [18.312283, 99.413179, "Lampang", "09:22:15"],
            [18.281088, 99.469882, "Lampang (Station)", "09:27:25"],
            [18.275846, 99.47753, "Lampang", "09:32:24"],
            [18.223882, 99.515192, "Lampang", "09:37:48"],
            [18.240787, 99.596923, "Lampang", "09:48:13"],
            [18.256232, 99.655373, "Mae Mo", "09:53:39"],
            [18.264667, 99.709782, "Mae Mo", "09:58:27"],
            [18.277847, 99.801018, "Mae Mo", "10:06:25"],
            [18.297822, 99.86354, "Mae Mo", "10:14:25"],
            [18.211666, 99.871989, "Long, Phrae", "10:29:32"],
            [18.194947, 99.870168, "Long, Phrae", "10:32:30"],
            [18.096358, 99.866883, "Long, Phrae", "10:49:41"],
            [18.080372, 99.879712, "Long, Phrae", "10:59:32"],
            [18.040347, 99.916938, "Long, Phrae", "11:09:52"],
            [18.032004, 99.922519, "Long, Phrae", "11:11:34"],
            [17.97274, 100.052057, "Den Chai", "11:31:00"],
            [17.92115, 100.062211, "Den Chai", "11:36:34"],
            [17.881632, 100.040743, "Den Chai", "11:41:39"],
            [17.839016, 100.046134, "Uttaradit", "11:47:01"],
            [17.808954, 100.066603, "Uttaradit", "11:51:54"],
            [17.77201, 100.108, "Uttaradit", "11:57:12"],
            [17.723428, 100.126752, "Uttaradit", "12:02:22"],
            [17.652857, 100.122463, "Uttaradit", "12:07:28"],
            [17.639648, 100.10107, "Uttaradit", "12:12:16"],
            [16.817458, 100.25806, "Phitsanulok", "16:23:02"]
        ];

        // Scene Setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Bright Sky blue
        scene.fog = new THREE.FogExp2(0x87CEEB, 0.0008); // Lighter fog for better visibility

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 20000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true; // Enable shadows
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // --- ENHANCED DAYLIGHT LIGHTING ---
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
        scene.add(hemiLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 2.0); // Bright sunlight
        dirLight.position.set(500, 1000, 500);
        dirLight.castShadow = true;
        dirLight.shadow.camera.top = 500;
        dirLight.shadow.camera.bottom = -500;
        dirLight.shadow.camera.left = -500;
        dirLight.shadow.camera.right = 500;
        scene.add(dirLight);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        // Convert GPS to 3D Space (Scale/Mercator simplified)
        const scale = 5000;
        const centerLat = 17.5;
        const centerLon = 99.5;

        function gpsToVec3(lat, lon) {
            return new THREE.Vector3(
                (lon - centerLon) * Math.cos(centerLat * Math.PI / 180) * scale,
                0,
                -(lat - centerLat) * scale
            );
        }

        const points = rawData.map(d => gpsToVec3(d[0], d[1]));
        const curve = new THREE.CatmullRomCurve3(points);

        // Track
        const tubeGeo = new THREE.TubeGeometry(curve, 300, 1.8, 8, false);
        const tubeMat = new THREE.MeshPhongMaterial({ color: 0x666666, shininess: 10 });
        const track = new THREE.Mesh(tubeGeo, tubeMat);
        track.receiveShadow = true;
        scene.add(track);

        // Ground Plane (Daytime Green Terrain)
        const planeGeo = new THREE.PlaneGeometry(80000, 80000);
        const planeMat = new THREE.MeshPhongMaterial({ color: 0x4CAF50 }); // Grass green
        const plane = new THREE.Mesh(planeGeo, planeMat);
        plane.rotation.x = -Math.PI / 2;
        plane.position.y = -2;
        plane.receiveShadow = true;
        scene.add(plane);

        // Grid over ground
        const grid = new THREE.GridHelper(80000, 400, 0x388E3C, 0x388E3C);
        grid.position.y = -1.9;
        scene.add(grid);

        // Train Creation Factory
        function createTrain(mainColor, cabinColor, eyeColor) {
            const group = new THREE.Group();

            // Main Body
            const bodyGeo = new THREE.BoxGeometry(4.5, 5, 15);
            const bodyMat = new THREE.MeshPhongMaterial({ color: mainColor, shininess: 80 });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 2.5;
            body.castShadow = true;
            group.add(body);

            // Driver's Cabin
            const headGeo = new THREE.BoxGeometry(4.7, 4.5, 4);
            const headMat = new THREE.MeshPhongMaterial({ color: cabinColor });
            const head = new THREE.Mesh(headGeo, headMat);
            head.position.y = 3.5;
            head.position.z = 7.5;
            head.castShadow = true;
            group.add(head);

            // Windows / Front Lights
            const lightGeo = new THREE.CircleGeometry(0.8, 16);
            const lightMat = new THREE.MeshBasicMaterial({ color: eyeColor });
            const leftEye = new THREE.Mesh(lightGeo, lightMat);
            leftEye.position.set(-1.4, 3.0, 9.51);
            group.add(leftEye);
            const rightEye = leftEye.clone();
            rightEye.position.x = 1.4;
            group.add(rightEye);

            // Back tail light
            const tailLightGeo = new THREE.CircleGeometry(0.6, 16);
            const tailLightMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            const tailLight = new THREE.Mesh(tailLightGeo, tailLightMat);
            tailLight.rotation.y = Math.PI;
            tailLight.position.set(0, 2.5, -7.51);
            group.add(tailLight);

            return group;
        }

        // Create Trains
        const train1 = createTrain(0xD4AF37, 0x1a1a1a, 0xffff00); // Kiki Gold
        scene.add(train1);

        const train2 = createTrain(0x4682B4, 0xeeeeee, 0x00ffff); // Ocean Blue
        scene.add(train2);

        // Train States
        const trains = [
            { obj: train1, progress: 0.0, speed: 0.0004, name: "Kiki Gold (‡∏Ç‡∏ö‡∏ß‡∏ô‡∏ó‡∏≠‡∏á)", color: "#D4AF37" },
            { obj: train2, progress: 0.05, speed: 0.0004, name: "Ocean Express (‡∏Ç‡∏ö‡∏ß‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)", color: "#4682B4" } // Starts a bit ahead
        ];

        let activeTrainIndex = 0; // Default follow Train 1

        // View States
        let viewModes = ['front', 'third', 'drone'];
        let currentViewIndex = 0;

        // --- UI CONTROLS EXPOSED TO WINDOW ---
        window.cycleView = () => {
            currentViewIndex = (currentViewIndex + 1) % viewModes.length;
            const mode = viewModes[currentViewIndex];
            let modeName = "‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏ñ‡πÑ‡∏ü (Front)";
            if (mode === 'third') modeName = "‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏° (Third-Person)";
            if (mode === 'drone') modeName = "‡πÇ‡∏î‡∏£‡∏ô (Drone/Orbit)";
            document.getElementById('viewBtn').innerText = `${modeName}`;
        };

        window.selectTrain = (id) => {
            activeTrainIndex = id - 1;
            document.getElementById('btnTrain1').className = (id === 1) ? 'active' : '';
            document.getElementById('btnTrain2').className = (id === 2) ? 'active-blue' : '';

            const t = trains[activeTrainIndex];
            document.getElementById('trainSelectName').innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°: ‡∏Ç‡∏ö‡∏ß‡∏ô ${t.name}`;
            document.getElementById('trainSelectName').style.color = t.color;

            updateSpeedUI();
        };

        window.changeSpeed = (newSpeed) => {
            trains[activeTrainIndex].speed = newSpeed;
            updateSpeedUI();
        };

        window.resetTrip = () => {
            trains.forEach(t => t.progress = 0);
        };

        function updateSpeedUI() {
            const spd = trains[activeTrainIndex].speed;
            let lbl = "‡∏´‡∏¢‡∏∏‡∏î (Stop)";
            if (spd > 0.0002) lbl = "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥ ‚ñ∂‚ñ∂";
            else if (spd > 0) lbl = "‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡πâ‡∏≤ ‚ñ∂";
            else if (spd < -0.0002) lbl = "‚óÄ‚óÄ ‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡πá‡∏ß";
            else if (spd < 0) lbl = "‚óÄ ‡∏ñ‡∏≠‡∏¢‡∏ä‡πâ‡∏≤";

            document.getElementById('speedLabel').innerText = `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏ö‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${lbl}`;
        }

        // Info Panel Update
        function updateInfoPanel() {
            const t = trains[activeTrainIndex];
            let prog = t.progress;
            if (prog < 0) prog = 0;
            if (prog >= 1) prog = 0.999;

            const dataPoint = rawData[Math.floor(prog * (rawData.length - 1))];
            document.getElementById('location').innerText = `üìç ${dataPoint[2]}`;
            document.getElementById('timestamp').innerText = `‡πÄ‡∏ß‡∏•‡∏≤: ${dataPoint[3]}`;
        }

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);

            // Update all trains
            trains.forEach(t => {
                t.progress += t.speed;
                if (t.progress > 1) t.progress = 1; // Stop at end
                if (t.progress < 0) t.progress = 0; // Stop at start

                // Prevent exact 1 for getPointAt to avoid errors
                const safeProg = Math.min(Math.max(t.progress, 0), 0.999);
                const pos = curve.getPointAt(safeProg);
                const lookAtPos = curve.getPointAt(Math.min(safeProg + 0.001, 1));

                t.obj.position.copy(pos);
                t.obj.lookAt(lookAtPos);
            });

            // Camera Logic (Follows active train)
            const activeTrain = trains[activeTrainIndex];
            const safeProg = Math.min(Math.max(activeTrain.progress, 0), 0.999);
            const pos = curve.getPointAt(safeProg);
            const mode = viewModes[currentViewIndex];

            updateInfoPanel();

            if (mode === 'front') {
                // Driver view
                const camOffset = new THREE.Vector3(0, 5, 8);
                camOffset.applyQuaternion(activeTrain.obj.quaternion);
                camera.position.copy(pos).add(camOffset);

                const camLookAt = new THREE.Vector3(0, 2, 80);
                camLookAt.applyQuaternion(activeTrain.obj.quaternion);
                camera.lookAt(pos.clone().add(camLookAt));
                controls.enabled = false;

            } else if (mode === 'third') {
                // Smooth Third Person View
                const camOffset = new THREE.Vector3(0, 15, -45); // High and back
                camOffset.applyQuaternion(activeTrain.obj.quaternion);

                camera.position.lerp(pos.clone().add(camOffset), 0.1);

                const camLookAt = new THREE.Vector3(0, 10, 30); // Look at train body + ahead
                camLookAt.applyQuaternion(activeTrain.obj.quaternion);

                // Smooth lookat
                const currentLook = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
                const targetLook = pos.clone().add(camLookAt).sub(camera.position).normalize();
                currentLook.lerp(targetLook, 0.1);
                camera.lookAt(camera.position.clone().add(currentLook));

                controls.enabled = false;

            } else {
                // Drone Orbit View
                controls.target.copy(activeTrain.obj.position);
                controls.enabled = true;
                controls.update();
            }

            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>

</html>